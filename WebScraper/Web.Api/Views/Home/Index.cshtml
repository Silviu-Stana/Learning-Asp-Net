@model IEnumerable<Domain.Entities.Listing>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Listings</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <style>
        body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; font-size: 1.05rem; background: #f3f4f6; }
        .ad-card { border-radius: 2rem; box-shadow: 0 8px 20px rgba(16,24,40,0.08); transition: transform .18s ease, box-shadow .18s ease; overflow: hidden; }
        .ad-card:hover { transform: translateY(-6px); box-shadow: 0 18px 40px rgba(16,24,40,0.12); }
        .image-box { position: relative; }
        .price-badge { position: absolute; right: 12px; top: 12px; background: linear-gradient(90deg,#ff6b6b,#ff8e53); color: #fff; padding: 8px 12px; border-radius: 999px; font-weight:700; box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
        .ad-title { font-size: 1.35rem; font-weight: 700; margin-bottom: 6px; }

        .ad-seller {
            font-size: 1.25rem;
            color: #6b7280;
            margin-bottom: 8px;
        }
        .ad-desc { font-size: 1.02rem; color: #374151; max-height: 6.5rem; overflow: auto; }
        .list-group-item { font-size: 1.02rem; }
        .card-links a { margin-right: 2px; }
        .card-body { padding-bottom: .5rem; }

        .list-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.25rem;
            width: 80%;
            margin: 0 auto;
        }

        /* Each ad card should have a white background so it stands out on the gray page */
        .ad-card { background: #ffffff; }
        .ad-item { display: block; }
        @@media (min-width: 576px) { .list-grid { grid-template-columns: repeat(2, 1fr); } }
        @@media (min-width: 768px) { .list-grid { grid-template-columns: repeat(3, 1fr); } }
        @@media (min-width: 992px) { .list-grid { grid-template-columns: repeat(4, 1fr); } }
    </style>
</head>
<body>
    <div class="py-4">
        <h1 class="text-center mb-4">WebScraper</h1>
        <div class="search-bar mb-4" style="display:flex;align-items:center;justify-content:center;">
            <form id="scrapeForm" style="width:100%;max-width:1100px;">
                <div style="display:flex;gap:8px;">
                    <input id="scrapeUrl" type="url" placeholder="Paste listing URL (OLX, Storia...)" aria-label="Listing URL" required
                           style="flex:1;padding:20px 24px;border-radius:999px;border:1px solid #e5e7eb;font-size:1.1rem;box-shadow:0 6px 18px rgba(16,24,40,0.04);" />
                    <button id="scrapeBtn" type="submit" class="btn btn-primary" style="padding:14px 22px;border-radius:999px;font-size:1.05rem;">Scrape</button>
                </div>
        <div id="urlSpinner" style="display:none;max-width:1100px;margin:6px auto 12px auto;text-align:center;">
            <div class="spinner-border" role="status" style="width:3rem;height:3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div style="margin-top:6px;font-weight:600;">Loading listing links…</div>
        </div>
            </form>
        </div>
        @if (Model?.Any() == true)
        {
            <div class="export-actions mb-3" style="display:flex;gap:10px;align-items:center;justify-content:center;">
                <button id="exportCsvBtn" type="button" class="btn" style="background:#10b981;color:#fff;padding:10px 18px;border-radius:999px;font-weight:600;">CSV</button>
                <button id="exportJsonBtn" type="button" class="btn" style="background:#3b82f6;color:#fff;padding:10px 18px;border-radius:999px;font-weight:600;">JSON</button>
                <button id="exportExcelBtn" type="button" class="btn" style="background:#f59e0b;color:#fff;padding:10px 18px;border-radius:999px;font-weight:600;">Excel</button>
            </div>

            <script>
                // embed server model for client-side exports
                window.__initialListings = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
            </script>
        }
        <div id="bulkProgress" class="mb-3" style="display:none;max-width:1200px;margin:0 auto;position:fixed;left:50%;transform:translateX(-50%);top:18px;z-index:1050;padding:12px 18px;background:rgba(255,255,255,0.98);border-radius:18px;box-shadow:0 10px 30px rgba(16,24,40,0.12);">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;">
                <div style="font-size:1.15rem;font-weight:600;">Processing listings</div>
                <div id="progressCount" style="font-size:1.15rem;font-weight:600;">0 / 10</div>
            </div>
            <div class="progress" style="height:44px;border-radius:12px;overflow:hidden;margin-top:10px;">
                <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width:0%;height:100%;font-weight:700;display:flex;align-items:center;justify-content:center;font-size:1.05rem;">0%</div>
            </div>
        </div>
        <div class="list-grid mt-3;">
            @foreach (var item in Model)
            {
                <div class="ad-item">
                    <div class="card h-100 p-0 ad-card">
                        @if (item.Images?.FirstOrDefault() != null)
                        {
                            var fileName = item.Images.First().FileName ?? string.Empty;
                            <div class="image-box mb-3" style="height:340px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;padding:8px;">
                                <div class="price-badge">@((item.Price>0)? String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:N0} {1}", item.Price, item.Currency) : "Free")</div>
                                <img src="/Images/@Uri.EscapeDataString(fileName)" class="card-img-top" alt="@item.Title" style="max-height:100%;max-width:100%;object-fit:contain;border-radius:18px;" />
                            </div>
                        }
                        <div class="card-body px-4 py-3">
                            <div class="ad-title">@item.Title</div>
                            <div class="ad-seller">@item.SellerName</div>
                            <p class="ad-desc">@item.Description</p>
                        </div>
                        <ul class="list-group list-group-flush" style="margin:8px 0;padding:0 16px;">
                            <li class="list-group-item">Location: <span class="text-muted">@item.Location</span></li>
                        </ul>
                        <div class="card-body px-4 pb-4 card-links">
                            <a href="@item.OriginalUrl" target="_blank" class="card-link btn btn-outline-primary btn-sm">View on OLX</a>
                            <a href="/api/listings/@item.Id" class="card-link btn btn-outline-secondary btn-sm">API</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    <script>
        const form = document.getElementById('scrapeForm');
        const input = document.getElementById('scrapeUrl');
        const btn = document.getElementById('scrapeBtn');
        const spinner = document.getElementById('urlSpinner');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = input.value?.trim();
            if (!url) return;
            btn.disabled = true;
            const oldText = btn.innerText;
            btn.innerText = 'Scraping...';

            try {
                // determine if this is a search url by checking for /q- anywhere
                const isSearch = /\/q-[^\/]+/i.test(url);

                if (!isSearch) {
                    // single listing
                    const res = await fetch('/api/listings', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ url })
                    });
                    if (!res.ok) {
                        const txt = await res.text();
                        alert('Scrape failed: ' + res.status + '\n' + txt);
                    } else {
                        window.location.reload();
                    }
                } else {
                    // search page: extract search keyword, then extract urls
                    spinner.style.display = 'block';
                    try {
                        await fetch('/api/listings/extract-keyword', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ url }) });
                    } catch { }

                    // fetch listing urls
                    let extractRes;
                    try {
                        extractRes = await fetch('/api/listings/extract-urls', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ url }) });
                    } catch (ex) {
                        spinner.style.display = 'none';
                        alert('Failed to fetch listing URLs: ' + ex);
                        return;
                    }

                    spinner.style.display = 'none';

                    if (!extractRes.ok) {
                        const txt = await extractRes.text();
                        alert('Failed to extract URLs: ' + extractRes.status + '\n' + txt);
                        return;
                    }

                    const urls = await extractRes.json();
                    if (!Array.isArray(urls) || urls.length === 0) {
                        alert('No listings found on the search page');
                        return;
                    }

                    // show progress UI and process each URL sequentially
                    const progressEl = document.getElementById('bulkProgress');
                    progressEl.style.display = 'block';
                    const total = Math.min(10, urls.length);
                    document.getElementById('progressCount').innerText = `0 / ${total}`;
                    const bar = document.getElementById('progressBar');
                    bar.style.width = '0%';
                    bar.innerText = '0%';
                    let completed = 0;

                    for (let u of urls.slice(0, total)) {
                        try {
                            await fetch('/api/listings', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ url: u }) });
                        } catch (e) {
                            // ignore per-item error
                        }
                        completed++;
                        const pct = Math.round((completed/total)*100);
                        bar.style.width = pct + '%';
                        bar.innerText = pct + '%';
                        document.getElementById('progressCount').innerText = `${completed} / ${total}`;
                    }

                    // finished
                    window.location.reload();
                }
            } catch (err) {
                alert('Error: ' + err);
            } finally {
                btn.disabled = false;
                btn.innerText = oldText;
            }
        });

        // Client-side export handlers — use visible listings embedded in window.__initialListings
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');

        function getVisibleListings() {
            try {
                return window.__initialListings || [];
            } catch {
                return [];
            }
        }

        function escapeCsv(value) {
            if (value == null) return '';
            const s = String(value);
            const escaped = s.replace(/"/g, '""');
            if (/[",\n\r]/.test(s)) return '"' + escaped + '"';
            return escaped;
        }

        function downloadBlob(data, mime, filename) {
            const blob = new Blob([data], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        if (exportJsonBtn) exportJsonBtn.addEventListener('click', () => {
            const items = getVisibleListings();
            const json = JSON.stringify(items, null, 2);
            downloadBlob(json, 'application/json', 'listings.json');
        });

        if (exportCsvBtn) exportCsvBtn.addEventListener('click', () => {
            const items = getVisibleListings();
            if (!items || items.length === 0) { alert('No listings to export'); return; }
            const headers = ['Id','Title','Price','Currency','Location','SellerName','Views','OriginalUrl','ExtractionDate','ListingId','Description'];
            const lines = [headers.join(',')];
            for (const it of items) {
                lines.push([
                    it.Id ?? '',
                    escapeCsv(it.Title),
                    (it.Price ?? '').toString(),
                    escapeCsv(it.Currency),
                    escapeCsv(it.Location),
                    escapeCsv(it.SellerName),
                    it.Views ?? '',
                    escapeCsv(it.OriginalUrl),
                    it.ExtractionDate ?? '',
                    escapeCsv(it.ListingId),
                    escapeCsv(it.Description)
                ].join(','));
            }
            downloadBlob(lines.join('\r\n'), 'text/csv;charset=utf-8;', 'listings.csv');
        });

        if (exportExcelBtn) exportExcelBtn.addEventListener('click', () => {
            // Excel can open CSV — provide CSV but with xlsx filename for convenience
            const items = getVisibleListings();
            if (!items || items.length === 0) { alert('No listings to export'); return; }
            const headers = ['Id','Title','Price','Currency','Location','SellerName','Views','OriginalUrl','ExtractionDate','ListingId','Description'];
            const lines = [headers.join(',')];
            for (const it of items) {
                lines.push([
                    it.Id ?? '',
                    escapeCsv(it.Title),
                    (it.Price ?? '').toString(),
                    escapeCsv(it.Currency),
                    escapeCsv(it.Location),
                    escapeCsv(it.SellerName),
                    it.Views ?? '',
                    escapeCsv(it.OriginalUrl),
                    it.ExtractionDate ?? '',
                    escapeCsv(it.ListingId),
                    escapeCsv(it.Description)
                ].join(','));
            }
            downloadBlob(lines.join('\r\n'), 'application/vnd.ms-excel', 'listings.xlsx');
        });
    </script>
</body>
</html>