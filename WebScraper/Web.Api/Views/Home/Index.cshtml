@model IEnumerable<(string Source, Domain.Entities.Listing Listing)>
@using System.Linq
@{
    var exportEntries = (Model ?? Enumerable.Empty<(string Source, Domain.Entities.Listing Listing)>())
        .Select(item => new
        {
            Source = item.Source,
            Id = item.Listing?.Id ?? 0,
            Title = item.Listing?.Title ?? string.Empty,
            Price = item.Listing?.Price ?? 0,
            Currency = item.Listing?.Currency ?? string.Empty,
            Location = item.Listing?.Location ?? string.Empty,
            SellerName = item.Listing?.SellerName ?? string.Empty,
            Views = item.Listing?.Views ?? string.Empty,
            OriginalUrl = item.Listing?.OriginalUrl ?? string.Empty,
            ExtractionDate = item.Listing?.ExtractionDate,
            ListingId = item.Listing?.ListingId ?? string.Empty,
            Description = item.Listing?.Description ?? string.Empty
        })
        .ToList();
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Listings</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <style>
        body {
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            font-size: 1.05rem;
            background: #f3f4f6;
        }

        .ad-card {
            border-radius: 2rem;
            box-shadow: 0 8px 20px rgba(16,24,40,0.08);
            transition: transform .18s ease, box-shadow .18s ease;
            overflow: hidden;
        }

            .ad-card:hover {
                transform: translateY(-6px);
                box-shadow: 0 18px 40px rgba(16,24,40,0.12);
            }

        .image-box {
            position: relative;
        }

        .price-badge {
            position: absolute;
            right: 12px;
            top: 12px;
            background: linear-gradient(90deg,#ff6b6b,#ff8e53);
            color: #fff;
            padding: 8px 12px;
            border-radius: 999px;
            font-weight: 700;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        }

        .ad-title {
            font-size: 1.35rem;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .ad-seller {
            font-size: 1.25rem;
            color: #228B22;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .ad-desc {
            font-size: 1.02rem;
            color: #374151;
            max-height: 6.5rem;
            overflow: auto;
        }

        .list-group-item {
            font-size: 1.02rem;
        }

        .card-links a {
            margin-right: 2px;
        }

        .card-body {
            padding-bottom: .5rem;
        }

        .list-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.25rem;
            width: 80%;
            margin: 0 auto;
        }

        /* Each ad card should have a white background so it stands out on the gray page */
        .ad-card {
            background: #ffffff;
        }

        .ad-item {
            display: block;
        }

        @@media (min-width: 576px) {
            .list-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @@media (min-width: 768px) {
            .list-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @@media (min-width: 992px) {
            .list-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .source-olx {
            color: #3b82f6;
            font-weight: bold;
        }

        .source-storia {
            color: #10b981;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="py-4">
        <h1 class="text-center mb-4">WebScraper</h1>
        <div class="search-bar mb-4" style="display:flex;align-items:center;justify-content:center;">
            @* Form submissions run via JS:
            -we fetch listing URLs from api/listings/extract-urls
            -scrape/save each one through api/listings
            -and update the progress bar/count after every request
            *@
            <form method="get" action="/Home/Index" style="width:100%;max-width:1100px;">
                <div style="display:flex;gap:8px;align-items:center;">
                    <input name="searchUrl" type="url" placeholder="Paste listing URL (OLX, Storia...)" aria-label="Listing URL" required
                           style="flex:1;padding:20px 24px;border-radius:999px;border:1px solid #e5e7eb;font-size:1.1rem;box-shadow:0 6px 18px rgba(16,24,40,0.04);" />
                    <select name="resultsCount" class="form-select" style="width:auto;">
                        <option value="10">10 Results</option>
                        <option value="20">20 Results</option>
                        <option value="50">50 Results</option>
                    </select>
                    <button type="submit" class="btn btn-primary" style="padding:14px 22px;border-radius:999px;font-size:1.05rem;">Search</button>
                </div>
            </form>
        </div>
        <div id="urlSpinner" style="display:none;max-width:1100px;margin:6px auto 12px auto;text-align:center;">
            <div class="spinner-border" role="status" style="width:3rem;height:3rem;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <div style="margin-top:6px;font-weight:600;">Loading listing links...</div>
        </div>
        <div id="bulkProgress" class="mb-3" style="display:none;max-width:1200px;margin:0 auto;position:fixed;left:50%;transform:translateX(-50%);top:18px;z-index:1050;padding:12px 18px;background:rgba(255,255,255,0.98);border-radius:18px;box-shadow:0 10px 30px rgba(16,24,40,0.12);">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;">
                <div style="font-size:1.15rem;font-weight:600;">Processing listings</div>
                <div id="progressCount" style="font-size:1.15rem;font-weight:600;">0 / 10</div>
            </div>
            <div class="progress" style="height:44px;border-radius:12px;overflow:hidden;margin-top:10px;">
                <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width:0%;height:100%;font-weight:700;display:flex;align-items:center;justify-content:center;font-size:1.05rem;">0%</div>
            </div>
            <div id="progressStatus" class="mt-2" style="font-size:0.95rem;color:#4b5563;display:none;">Waiting...</div>
        </div>
        @if (Model?.Any() == true)
        {
            <div class="export-actions mb-3" style="display:flex;gap:10px;align-items:center;justify-content:center;">
                <button id="exportCsvBtn" type="button" class="btn" style="background:#10b981;color:#fff;padding:10px 18px;border-radius:999px;font-weight:600;">CSV</button>
                <button id="exportJsonBtn" type="button" class="btn" style="background:#3b82f6;color:#fff;padding:10px 18px;border-radius:999px;font-weight:600;">JSON</button>
                <button id="exportExcelBtn" type="button" class="btn" style="background:#f59e0b;color:#fff;padding:10px 18px;border-radius:999px;font-weight:600;">Excel</button>
            </div>

            <script>
                // embed flattened server model for client-side exports
                window.__initialListings = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(exportEntries));
            </script>
        }

        <div class="list-grid mt-3;">
            @foreach (var item in Model)
            {
                <div class="ad-item">
                    <div class="card h-100 p-0 ad-card">
                        @if (item.Listing.Images?.FirstOrDefault() != null)
                        {
                            var fileName = item.Listing.Images.First().FileName ?? string.Empty;
                            <div class="image-box mb-3" style="height:340px;display:flex;align-items:center;justify-content:center;background:#f8f9fa;padding:8px;">
                                <div class="price-badge">@((item.Listing.Price > 0) ? String.Format(System.Globalization.CultureInfo.InvariantCulture, "{0:N0} {1}", item.Listing.Price, item.Listing.Currency) : "Free")</div>
                                <img src="/Images/@Uri.EscapeDataString(fileName)" class="card-img-top" alt="@item.Listing.Title" style="max-height:100%;max-width:100%;object-fit:contain;border-radius:18px;" />
                            </div>
                        }
                        <div class="card-body px-4 py-3">
                            <div class="ad-title">@item.Listing.Title</div>
                            <div class="ad-seller">@item.Listing.SellerName</div>
                            <p class="ad-desc">@item.Listing.Description</p>
                            <div class="source @("From OLX" == item.Source ? "source-olx" : "source-storia")">@item.Source</div>
                        </div>
                        <ul class="list-group list-group-flush" style="margin:8px 0;padding:0 16px;">
                            <li class="list-group-item">Location: <span class="text-muted">@item.Listing.Location</span></li>
                            <li class="list-group-item">Vizualizari: <span class="text-muted">@item.Listing.Views</span></li>
                        </ul>
                        <div class="card-body px-4 pb-4 card-links">
                            <a href="@item.Listing.OriginalUrl" target="_blank" class="card-link btn btn-outline-primary btn-sm">View on Source</a>
                            <a href="/api/listings/@item.Listing.Id" class="card-link btn btn-outline-secondary btn-sm">API</a>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const form = document.querySelector("form");
            const spinner = document.getElementById("urlSpinner");
            const bulkProgress = document.getElementById("bulkProgress");
            const progressBar = document.getElementById("progressBar");
            const progressCount = document.getElementById("progressCount");
            const progressStatus = document.getElementById("progressStatus");
            const resultsSelect = form?.querySelector('select[name="resultsCount"]');

            if (!form || !spinner || !bulkProgress || !progressBar || !progressCount || !progressStatus) {
                console.error("Form or progress elements not found.");
                return;
            }

            form.addEventListener("submit", async function (event) {
                event.preventDefault();

                if (!form.searchUrl) return;

                const searchUrl = form.searchUrl.value.trim();
                if (!searchUrl) return;

                const requestedResults = parseInt(resultsSelect?.value ?? '10', 10) || 10;

                spinner.style.display = "block";
                bulkProgress.style.display = "block";
                progressStatus.style.display = "block";
                progressStatus.innerText = "Extracting listing links...";
                progressBar.classList.add('progress-bar-striped', 'progress-bar-animated');
                progressBar.style.width = "0%";
                progressBar.innerText = "0%";
                progressCount.innerText = `0 / ${requestedResults}`;

                try {
                    const extractResponse = await fetch('/api/listings/extract-urls', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url: searchUrl, results: requestedResults })
                    });

                    if (!extractResponse.ok) {
                        progressStatus.innerText = 'Failed to fetch listing URLs.';
                        spinner.style.display = 'none';
                        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                        return;
                    }

                    const listingUrls = await extractResponse.json();
                    const total = Array.isArray(listingUrls) ? listingUrls.length : 0;

                    if (total === 0) {
                        progressStatus.innerText = 'No listings found for this search.';
                        spinner.style.display = 'none';
                        progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                        progressBar.style.width = '0%';
                        progressBar.innerText = '0%';
                        progressCount.innerText = '0 / 0';
                        return;
                    }

                    progressCount.innerText = `0 / ${total}`;
                    progressStatus.innerText = 'Scraping listings…';

                    for (let i = 0; i < total; i++) {
                        try {
                            const scrapeResponse = await fetch('/api/listings', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ url: listingUrls[i] })
                            });

                            if (!scrapeResponse.ok && scrapeResponse.status !== 409) {
                                console.warn('Scrape failed for', listingUrls[i]);
                            }
                        } catch (scrapeError) {
                            console.warn('Scrape error', scrapeError);
                        }

                        const completed = i + 1;
                        const percentage = Math.round((completed / total) * 100);
                        progressBar.style.width = percentage + '%';
                        progressBar.innerText = percentage + '%';
                        progressCount.innerText = `${completed} / ${total}`;
                    }

                    progressStatus.innerText = 'Refreshing results...';
                    progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                    spinner.style.display = 'none';
                    window.location.href = `/Home/Index?searchUrl=${encodeURIComponent(searchUrl)}`;
                } catch (err) {
                    console.error(err);
                    progressStatus.innerText = 'Unexpected error while scraping listings.';
                    progressBar.classList.remove('progress-bar-striped', 'progress-bar-animated');
                    spinner.style.display = 'none';
                }
            });
        });

        // Embed server model for client-side exports
        window.__initialListings = window.__initialListings || [];
    </script>
    <script>
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        const exportExcelBtn = document.getElementById('exportExcelBtn');

        function getVisibleListings() {
            try {
                return window.__initialListings || [];
            } catch {
                return [];
            }
        }

        function escapeCsv(value) {
            if (value == null) return '';
            const s = String(value);
            const escaped = s.replace(/"/g, '""');
            if (/[",\n\r]/.test(s)) return '"' + escaped + '"';
            return escaped;
        }

        function downloadBlob(data, mime, filename) {
            const blob = new Blob([data], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        if (exportJsonBtn) exportJsonBtn.addEventListener('click', () => {
            const items = getVisibleListings();
            const json = JSON.stringify(items, null, 2);
            downloadBlob(json, 'application/json', 'listings.json');
        });

        if (exportCsvBtn) exportCsvBtn.addEventListener('click', () => {
            const items = getVisibleListings();
            if (!items || items.length === 0) { alert('No listings to export'); return; }
            const headers = ['Id','Title','Price','Currency','Location','SellerName','Views','OriginalUrl','ExtractionDate','ListingId','Description'];
            const lines = [headers.join(',')];
            for (const it of items) {
                lines.push([
                    it.Id ?? '',
                    escapeCsv(it.Title),
                    (it.Price ?? '').toString(),
                    escapeCsv(it.Currency),
                    escapeCsv(it.Location),
                    escapeCsv(it.SellerName),
                    (it.Views ?? '').toString(),
                    escapeCsv(it.OriginalUrl),
                    escapeCsv(it.ExtractionDate),
                    escapeCsv(it.ListingId),
                    escapeCsv(it.Description)
                ].join(','));
            }
            downloadBlob(lines.join('\r\n'), 'text/csv;charset=utf-8;', 'listings.csv');
        });

        if (exportExcelBtn) exportExcelBtn.addEventListener('click', () => {
            // Excel can open CSV — provide CSV but with xlsx filename for convenience
            const items = getVisibleListings();
            if (!items || items.length === 0) { alert('No listings to export'); return; }
            const headers = ['Id','Title','Price','Currency','Location','SellerName','Views','OriginalUrl','ExtractionDate','ListingId','Description'];
            const lines = [headers.join(',')];
            for (const it of items) {
                lines.push([
                    it.Id ?? '',
                    escapeCsv(it.Title),
                    (it.Price ?? '').toString(),
                    escapeCsv(it.Currency),
                    escapeCsv(it.Location),
                    escapeCsv(it.SellerName),
                    (it.Views ?? '').toString(),
                    escapeCsv(it.OriginalUrl),
                    escapeCsv(it.ExtractionDate),
                    escapeCsv(it.ListingId),
                    escapeCsv(it.Description)
                ].join(','));
            }
            downloadBlob(lines.join('\r\n'), 'application/vnd.ms-excel', 'listings.xlsx');
        });
    </script>
</body>
</html>